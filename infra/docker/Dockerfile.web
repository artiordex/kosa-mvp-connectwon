# Description : Dockerfile.web - ğŸ“Œ web docker build
# Author      : Shiwoo Min
# Date        : 2025-09-06

# ì›¹ í”„ë¡ íŠ¸ì—”ë“œìš© Docker ì´ë¯¸ì§€ ë¹Œë“œ íŒŒì¼
# Next.js ê¸°ë°˜ React ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜

# Next.js ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
FROM node:20-slim AS build

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# pnpm íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € í™œì„±í™”
RUN corepack enable && corepack prepare pnpm@10.15.1 --activate

# ì˜ì¡´ì„± íŒŒì¼ë“¤ì„ ë¨¼ì € ë³µì‚¬
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY tsconfig.json tsconfig.base.json ./

# packagesì™€ apps ë””ë ‰í† ë¦¬ ì „ì²´ ë³µì‚¬ (ì˜ì¡´ì„± í•´ê²°ì„ ìœ„í•´)
COPY packages ./packages
COPY apps ./apps

# ì˜ì¡´ì„± ì„¤ì¹˜ (lockfile ê¸°ë°˜)
RUN pnpm install --frozen-lockfile

# Next.js ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ (ì •ì  íŒŒì¼ ìƒì„±)
RUN pnpm --filter @connectwon/web build

# Next.js standalone ëª¨ë“œ ì‹¤í–‰ìš© ìµœì†Œ ì´ë¯¸ì§€
FROM node:20-slim AS production

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# í”„ë¡œë•ì…˜ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV NODE_ENV=production

# Next.js standalone ë¹Œë“œ ê²°ê³¼ë¬¼ ë³µì‚¬
COPY --from=build /app/apps/web/.next/standalone ./
COPY --from=build /app/apps/web/.next/static ./.next/static
COPY --from=build /app/apps/web/public ./public

# ì›¹ ì„œë²„ í¬íŠ¸ ë…¸ì¶œ (Next.js ê¸°ë³¸ê°’: 3000)
EXPOSE 3000

# ì»¨í…Œì´ë„ˆ ì‹œì‘ ì‹œ Next.js ì„œë²„ ì‹¤í–‰
CMD ["node", "server.js"]
