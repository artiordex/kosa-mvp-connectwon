/**
 * Description : nginx.conf - ğŸ“Œ nginx ê¸°ë³¸ ì„¤ì •
 * Author      : Shiwoo Min
 * Date        : 2025-09-05
 */

# /etc/nginx/nginx.conf ë¡œ ë³µì‚¬/ë§ˆìš´íŠ¸í•´ì„œ ì‚¬ìš©
user  nginx;
worker_processes auto;

events { worker_connections 1024; }

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  sendfile      on;
  tcp_nopush    on;
  tcp_nodelay   on;
  keepalive_timeout 65;
  server_tokens off;

  # WebSocket ì—…ê·¸ë ˆì´ë“œ í—¬í¼
  map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
  }

  # ì••ì¶• (ë¸Œë¼ìš°ì €ê°€ ì§€ì› ì‹œ)
  gzip on;
  gzip_comp_level 5;
  gzip_min_length 1024;
  gzip_vary on;
  gzip_types text/plain text/css application/json application/javascript application/xml image/svg+xml;

  # (ì„ íƒ) brotli ëª¨ë“ˆì´ ìˆëŠ” ì´ë¯¸ì§€ë©´ ì£¼ì„ í•´ì œ
  # brotli on;
  # brotli_comp_level 5;
  # brotli_types text/plain text/css application/json application/javascript application/xml image/svg+xml;

  # Docker compose ì„œë¹„ìŠ¤ëª…ì„ ê·¸ëŒ€ë¡œ upstream í˜¸ìŠ¤íŠ¸ë¡œ ì‚¬ìš©
  upstream web {  server web:3000; }   # Next.js
  upstream api {  server api:8080; }   # API (Node/Spring ë“± ì‹¤ì œ í¬íŠ¸ë¡œ ìˆ˜ì •)

  server {
    listen 80;
    server_name _;   # ìš´ì˜ì—ì„  your.domain ìœ¼ë¡œ êµì²´
    client_max_body_size 20m;

    # --- í—¬ìŠ¤ ì²´í¬ ---
    location = /health {
      return 200 'ok';
      add_header Content-Type text/plain;
    }

    # --- API ë¨¼ì € ë§¤ì¹­ (/api -> api ì„œë¹„ìŠ¤) ---
    location /api/ {
      proxy_pass http://api/;     # ìŠ¬ë˜ì‹œ ìœ ì§€: /api/foo -> /api/foo
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Connection $connection_upgrade;
      proxy_set_header Upgrade $http_upgrade;   # WebSocket/SSE
      proxy_read_timeout 75s;
    }

    # --- Next.js ì •ì ìì‚° ê°•ìºì‹œ ---
    location ~* ^/_next/static/ {
      proxy_pass http://web;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      expires 1y;
      add_header Cache-Control "public, max-age=31536000, immutable";
    }
    location ~* ^/(assets|static)/ {
      proxy_pass http://web;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      expires 30d;
      add_header Cache-Control "public, max-age=2592000";
    }

    # --- Next.js SSR/ë¼ìš°íŒ… (ì›¹ì†Œì¼“ í¬í•¨) ---
    location / {
      proxy_pass http://web;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Connection $connection_upgrade;
      proxy_set_header Upgrade $http_upgrade;   # Hot reload/WS
      proxy_read_timeout 75s;
    }

    # (ì„ íƒ) ê³µí†µ ë³´ì•ˆ í—¤ë” (HTTPSì—ì„œ íŠ¹íˆ ìœ íš¨)
    add_header X-Content-Type-Options nosniff always;
    add_header Referrer-Policy no-referrer-when-downgrade always;
    # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always; # HTTPSì—ì„œë§Œ
  }
}
