# Description : Dockerfile.api - ğŸ“Œ api docker build (ë””ë²„ê¹…ìš©)
# Author : Shiwoo Min
# Date : 2025-09-06

FROM node:20-slim AS build

WORKDIR /app

# pnpm í™œì„±í™”
RUN corepack enable && corepack prepare pnpm@10.15.1 --activate

# ëª¨ë“  íŒŒì¼ì„ ë³µì‚¬ (ë‚˜ì¤‘ì— ìµœì í™”)
COPY . .

# ì˜ì¡´ì„± ì„¤ì¹˜
RUN pnpm install --frozen-lockfile

# ë¹Œë“œ
RUN pnpm --filter @connectwon/api build

# í”„ë¡œë•ì…˜ ë‹¨ê³„
FROM node:20-slim AS production

WORKDIR /app
ENV NODE_ENV=production

# ë¹Œë“œ ê²°ê³¼ë¬¼ ë³µì‚¬
COPY --from=build /app/apps/api/dist ./dist
COPY --from=build /app/apps/api/package.json ./
COPY --from=build /app/node_modules ./node_modules

EXPOSE 8000
CMD ["node", "dist/app.js"]
